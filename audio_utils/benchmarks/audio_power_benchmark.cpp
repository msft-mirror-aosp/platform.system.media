/*
 * Copyright 2024 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <audio_utils/power.h>

#include <random>
#include <vector>

#include <audio_utils/format.h>
#include <benchmark/benchmark.h>
#include <log/log.h>

/*
Pixel 7 (USE_NEON code) 1024 frames
------------------------------------------------------------------------------------
Benchmark                       Time                      CPU             Iteration
------------------------------------------------------------------------------------
  #BM_Power_PCM16/0     180.97891633448947 ns     180.1272276967831 ns      3885852
  #BM_Power_PCM16/1       180.947387663606 ns    180.12366729181554 ns      3886541
  #BM_Power_PCM16/2       366.788606340951 ns     365.0981633489325 ns      1915715
  #BM_Power_PCM16/3      548.7117372721175 ns     546.1077741464976 ns      1282070
  #BM_Power_PCM16/4      729.3091325787765 ns     725.8914895381871 ns       964460
  #BM_Power_PCM16/5      729.5107214636998 ns     725.9903921261499 ns       964001
  #BM_Power_PCM16/6      729.3142860987979 ns     725.7270789310516 ns       964462
  #BM_Power_PCM16/7      728.8285153846795 ns     725.6857445895254 ns       964518
  #BM_Power_PCM16/8       910.266543588675 ns     905.9784034899902 ns       773412
  #BM_Power_PCM16/9      909.7631943495237 ns     905.5980073450368 ns       773039
  #BM_Power_PCM16/10     909.4817518460887 ns     905.3046969675422 ns       773201
  #BM_Power_PCM16/11    1090.5752804035608 ns    1085.4067030965386 ns       645075
  #BM_Power_PCM16/12    1090.1430777061082 ns    1085.3985691918976 ns       645090
  #BM_Power_PCM16/13     1090.074475934731 ns    1085.1795632613716 ns       645054
  #BM_Power_PCM16/14    1271.0181027106237 ns    1265.0655742741403 ns       553342
  #BM_Power_PCM16/15     1450.921852464041 ns    1444.5727666390078 ns       484494
  #BM_Power_PCM16/16    1451.2240897596057 ns    1444.6554862570126 ns       484538
  #BM_Power_PCM16/17    1812.7695622285537 ns    1804.1137781191355 ns       387992
  #BM_Power_PCM16/18    1812.6019333363201 ns    1804.0487200830873 ns       388033
  #BM_Power_PCM16/19     2172.960068355248 ns    2163.5280680444976 ns       323553
  #BM_Power_PCM16/20     2896.932275617628 ns     2882.070808558297 ns       242852
  #BM_Power_PCM16/21    2354.0114820280833 ns     2343.273892215966 ns       298727
  #BM_Power_PCM16/22     4341.411563591838 ns    4320.3065557379705 ns       162026
  #BM_Power_PCM24/0      726.5703267242005 ns     723.3638876888978 ns       967598
  #BM_Power_PCM24/1      726.8478512196587 ns     723.3996910023831 ns       967645
  #BM_Power_PCM24/2      1453.522365501612 ns     1446.817841538075 ns       483826
  #BM_Power_PCM24/3     2180.4783136728597 ns    2170.2972985542474 ns       322531
  #BM_Power_PCM24/4     2907.3817241064085 ns      2893.78803763662 ns       241892
  #BM_Power_PCM24/5       2907.93437008585 ns    2893.9130060933658 ns       241902
  #BM_Power_PCM24/6      2907.476982094115 ns     2893.869563779754 ns       241942
  #BM_Power_PCM24/7     2906.2742418195558 ns     2893.721987961765 ns       241896
  #BM_Power_PCM24/8      3634.429566572946 ns    3617.2687167986146 ns       193516
  #BM_Power_PCM24/9      3637.612631382197 ns    3617.0655648749726 ns       193503
  #BM_Power_PCM24/10    3637.7966951345143 ns    3617.4579242709196 ns       193532
  #BM_Power_PCM24/11     4360.471518019849 ns     4340.702796725793 ns       161260
  #BM_Power_PCM24/12     4359.483557914242 ns     4340.688663859648 ns       161263
  #BM_Power_PCM24/13     4361.102585926522 ns     4340.699237256582 ns       161260
  #BM_Power_PCM24/14     5087.945822701728 ns     5064.266827288351 ns       138213
  #BM_Power_PCM24/15     5814.759977572986 ns     5787.690635285585 ns       120922
  #BM_Power_PCM24/16     5815.644749452265 ns    5787.2178931701865 ns       120940
  #BM_Power_PCM24/17     7266.470565121046 ns     7234.610670139329 ns        96756
  #BM_Power_PCM24/18     7268.525628728221 ns    7234.5110649425615 ns        96747
  #BM_Power_PCM24/19     8716.083166871316 ns     8682.350888726245 ns        80621
  #BM_Power_PCM24/20     11639.32870672943 ns     11580.26249875915 ns        60446
  #BM_Power_PCM24/21     9446.785352486686 ns     9405.332101734537 ns        74429
  #BM_Power_PCM24/22     17463.72223575373 ns    17383.809277838518 ns        40268
  #BM_Power_PCM32/0     179.84309567370832 ns     179.0676549126645 ns      3908541
  #BM_Power_PCM32/1      179.9404439204146 ns     179.0010033549121 ns      3911876
  #BM_Power_PCM32/2     367.16608437351766 ns    365.42729213737346 ns      1915123
  #BM_Power_PCM32/3       550.277695550067 ns     547.9387707497883 ns      1277543
  #BM_Power_PCM32/4      731.4224075405458 ns     728.3597142669796 ns       960757
  #BM_Power_PCM32/5      731.8896053180963 ns     728.7127664668686 ns       960626
  #BM_Power_PCM32/6      731.6139555435336 ns      728.404691132571 ns       960493
  #BM_Power_PCM32/7      731.4526007701458 ns     728.5303351299617 ns       952526
  #BM_Power_PCM32/8      914.9957172964164 ns     910.4922825617709 ns       768908
  #BM_Power_PCM32/9      914.9228864106034 ns     910.3200879900779 ns       768723
  #BM_Power_PCM32/10     914.4295313745796 ns     910.2645292119196 ns       768796
  #BM_Power_PCM32/11    1097.4819073401923 ns    1092.6099713796307 ns       640453
  #BM_Power_PCM32/12     1098.341821642604 ns    1093.1572358279782 ns       640293
  #BM_Power_PCM32/13    1098.2661898965437 ns     1092.878152356299 ns       636508
  #BM_Power_PCM32/14    1280.2780676971747 ns    1274.5237323564186 ns       549208
  #BM_Power_PCM32/15    1462.3197864285032 ns    1455.9130929404507 ns       480824
  #BM_Power_PCM32/16    1462.7091956393392 ns    1455.9862690566056 ns       480739
  #BM_Power_PCM32/17    1827.1057526954876 ns     1818.949706155908 ns       384898
  #BM_Power_PCM32/18    1827.7309048929412 ns    1819.2175362902751 ns       384745
  #BM_Power_PCM32/19    2191.6910336275487 ns    2182.0570090137303 ns       320844
  #BM_Power_PCM32/20    2932.1382076410487 ns     2917.764512203257 ns       239936
  #BM_Power_PCM32/21     2384.572833177335 ns     2374.048604969875 ns       296266
  #BM_Power_PCM32/22     4396.192134082954 ns     4376.258719439749 ns       159930
  #BM_Power_FLOAT/0     167.25444234000543 ns    166.47183513094348 ns      4204937
  #BM_Power_FLOAT/1     167.24129258362885 ns     166.4590919078933 ns      4205036
  #BM_Power_FLOAT/2      351.4320774910175 ns     349.8888578977785 ns      2000574
  #BM_Power_FLOAT/3      532.5129107539586 ns     530.0978074251175 ns      1320411
  #BM_Power_FLOAT/4      716.8967761364072 ns     713.6935400332438 ns       980810
  #BM_Power_FLOAT/5      716.7889045409055 ns     713.7320038176421 ns       980708
  #BM_Power_FLOAT/6      717.0752796480707 ns     713.6972366395144 ns       980690
  #BM_Power_FLOAT/7      716.6102092628516 ns     713.7024690577491 ns       980698
  #BM_Power_FLOAT/8      899.5296958205339 ns     894.9512572444829 ns       782147
  #BM_Power_FLOAT/9      899.2820069645962 ns     894.9592230725831 ns       782158
  #BM_Power_FLOAT/10     899.3434261268515 ns     894.9564490846954 ns       782142
  #BM_Power_FLOAT/11    1079.2320050706119 ns    1074.9236482969181 ns       651197
  #BM_Power_FLOAT/12     1079.995203673193 ns    1074.9423856936505 ns       651123
  #BM_Power_FLOAT/13    1080.2950176525237 ns    1074.9553632314376 ns       651100
  #BM_Power_FLOAT/14    1260.4052233815107 ns    1254.9116087466343 ns       557838
  #BM_Power_FLOAT/15     1441.558180305023 ns    1434.8599962279143 ns       487794
  #BM_Power_FLOAT/16    1442.0232631999454 ns     1434.885356768729 ns       487809
  #BM_Power_FLOAT/17     1802.938510952263 ns    1794.8471734733112 ns       390037
  #BM_Power_FLOAT/18    1802.3492608362737 ns    1794.8067419071836 ns       390038
  #BM_Power_FLOAT/19    2163.5362062414747 ns    2154.6858791842915 ns       324875
  #BM_Power_FLOAT/20     2894.779758388722 ns     2882.248193812651 ns       242915
  #BM_Power_FLOAT/21     2345.738662867257 ns     2334.692247141554 ns       299812
  #BM_Power_FLOAT/22     4341.005108230952 ns      4318.48899075213 ns       162091

Pixel 7 (generic intrinsics)
audio_power_benchmark:
  #BM_Power_PCM16/0       337.760142649551 ns    336.25662704492527 ns      2081433
  #BM_Power_PCM16/1      337.9351210323131 ns     336.3553796166739 ns      2081152
  #BM_Power_PCM16/2      672.5364912371965 ns     669.4070783764836 ns      1045607
  #BM_Power_PCM16/3     1006.4414502095067 ns    1001.6641972800023 ns       698824
  #BM_Power_PCM16/4       1339.75865716885 ns    1333.3746327354206 ns       524826
  #BM_Power_PCM16/5      1339.747932594017 ns    1333.3662572435896 ns       525292
  #BM_Power_PCM16/6      1339.081792726286 ns    1333.2895640083038 ns       525010
  #BM_Power_PCM16/7     1338.8341052706744 ns    1333.1123506021647 ns       524857
  #BM_Power_PCM16/8     1674.8266277119628 ns    1667.4998296698461 ns       419773
  #BM_Power_PCM16/9     1675.1191347994438 ns    1667.2425555624354 ns       419978
  #BM_Power_PCM16/10      1674.71266726399 ns    1666.9600314300715 ns       419980
  #BM_Power_PCM16/11    2010.2484537350663 ns    2000.7651024934537 ns       349876
  #BM_Power_PCM16/12    2009.7556108023364 ns    2000.7828645744019 ns       349860
  #BM_Power_PCM16/13     2010.480003104438 ns     2000.914753011257 ns       349854
  #BM_Power_PCM16/14     2344.500011676101 ns    2333.4616815513364 ns       299973
  #BM_Power_PCM16/15     2679.159956909422 ns    2667.7558284453257 ns       262377
  #BM_Power_PCM16/16     2680.335192003616 ns    2667.7298096639197 ns       262378
  #BM_Power_PCM16/17    3349.3067194938394 ns     3333.070394636596 ns       210016
  #BM_Power_PCM16/18    3347.5797958892135 ns     3332.993186265871 ns       210017
  #BM_Power_PCM16/19    4017.7712421677643 ns    4000.1111676171067 ns       175006
  #BM_Power_PCM16/20     5353.909304200122 ns     5332.241398226324 ns       131252
  #BM_Power_PCM16/21     4351.829067676431 ns      4333.01033665303 ns       161561
  #BM_Power_PCM16/22    8033.3449012838255 ns    7998.6481625377255 ns        87512
  #BM_Power_PCM24/0      726.0724740108452 ns      722.793010652718 ns       968016
  #BM_Power_PCM24/1      726.5141612892924 ns     723.0428633830344 ns       968379
  #BM_Power_PCM24/2     1453.0771079215267 ns    1446.3117483448088 ns       483932
  #BM_Power_PCM24/3      2179.805517686665 ns     2169.532832665915 ns       322636
  #BM_Power_PCM24/4     2904.8858799182244 ns     2892.571683017743 ns       241982
  #BM_Power_PCM24/5      2905.290520956667 ns    2892.6407436793943 ns       241986
  #BM_Power_PCM24/6     2905.7997231004174 ns    2892.3390330578545 ns       242000
  #BM_Power_PCM24/7     2906.2596490773803 ns    2892.7177675295025 ns       241992
  #BM_Power_PCM24/8      3632.076809461512 ns     3615.545919869441 ns       193609
  #BM_Power_PCM24/9     3632.5518469824924 ns    3615.6390283459427 ns       193608
  #BM_Power_PCM24/10    3631.5230189943823 ns     3615.826974034231 ns       193601
  #BM_Power_PCM24/11     4358.713629609595 ns     4338.867286915848 ns       161333
  #BM_Power_PCM24/12     4359.231924050327 ns     4338.824437653807 ns       161333
  #BM_Power_PCM24/13     4356.325355513422 ns      4339.28872069524 ns       161322
  #BM_Power_PCM24/14     5086.698249103073 ns     5062.681608123064 ns       138273
  #BM_Power_PCM24/15    5812.5060886912215 ns     5785.645307165088 ns       120961
  #BM_Power_PCM24/16       5812.5832141796 ns     5785.508699569401 ns       120983
  #BM_Power_PCM24/17     7263.989452119297 ns     7231.864374560889 ns        96796
  #BM_Power_PCM24/18     7263.645282618586 ns     7231.993934070503 ns        96770
  #BM_Power_PCM24/19     8717.248425410799 ns     8678.296803709562 ns        80656
  #BM_Power_PCM24/20    11627.892071566856 ns    11574.479277610539 ns        60466
  #BM_Power_PCM24/21     9446.526244343248 ns     9406.349543664368 ns        74397
  #BM_Power_PCM24/22     17447.99081596151 ns    17374.784496239492 ns        40287
  #BM_Power_PCM32/0      366.5107706071915 ns     364.8308462714918 ns      1919065
  #BM_Power_PCM32/1      366.5168704771794 ns     364.7554321738571 ns      1918707
  #BM_Power_PCM32/2      730.2924269058933 ns     727.1057881827118 ns       962962
  #BM_Power_PCM32/3     1093.9912603896798 ns    1088.7929435922993 ns       642820
  #BM_Power_PCM32/4     1456.8093080845226 ns    1449.9832478951175 ns       482805
  #BM_Power_PCM32/5     1456.1232191254142 ns     1449.855881567137 ns       482839
  #BM_Power_PCM32/6     1456.2008645317271 ns     1449.290242604125 ns       482803
  #BM_Power_PCM32/7     1457.0090571482128 ns    1450.1991782065193 ns       482603
  #BM_Power_PCM32/8     1819.8793533353248 ns    1811.1948393741498 ns       386426
  #BM_Power_PCM32/9     1819.2882280461354 ns    1811.0842554160467 ns       386444
  #BM_Power_PCM32/10    1822.4888939503587 ns    1811.2359906431732 ns       386456
  #BM_Power_PCM32/11     2182.958268570418 ns     2172.377140481356 ns       322299
  #BM_Power_PCM32/12     2181.462500754493 ns     2171.936179393034 ns       322153
  #BM_Power_PCM32/13    2181.9423435499857 ns    2172.6346584016715 ns       322323
  #BM_Power_PCM32/14    2545.0172319340754 ns     2533.932252353998 ns       276231
  #BM_Power_PCM32/15    2910.0457980163624 ns    2897.3537004237564 ns       241648
  #BM_Power_PCM32/16    2911.5361569110396 ns     2897.792890320363 ns       241558
  #BM_Power_PCM32/17    3627.9648736853173 ns     3610.617067822403 ns       193815
  #BM_Power_PCM32/18     3626.573311653762 ns    3610.4587441726208 ns       193912
  #BM_Power_PCM32/19     4371.516904489751 ns     4351.228854700868 ns       160875
  #BM_Power_PCM32/20     5833.295410225075 ns    5806.0874899420005 ns       120551
  #BM_Power_PCM32/21    4733.5978237221925 ns     4713.533180254132 ns       148507
  #BM_Power_PCM32/22     8761.069766861208 ns     8719.434463509126 ns        80253
  #BM_Power_FLOAT/0      309.7573236829997 ns     308.3100559643444 ns      2270374
  #BM_Power_FLOAT/1     309.82671751979507 ns    308.31727146129305 ns      2269889
  #BM_Power_FLOAT/2      616.5533244216624 ns     613.6735468134156 ns      1140528
  #BM_Power_FLOAT/3      924.1979909165235 ns     919.7778739898862 ns       761050
  #BM_Power_FLOAT/4      1229.228159640607 ns     1223.550260462179 ns       572060
  #BM_Power_FLOAT/5     1229.1571063156637 ns    1223.5816435152462 ns       572103
  #BM_Power_FLOAT/6      1229.316886623843 ns    1223.9691527852942 ns       572110
  #BM_Power_FLOAT/7     1230.6891998748167 ns    1223.8458668046858 ns       571882
  #BM_Power_FLOAT/8     1537.1050916942645 ns    1530.2548960451468 ns       457410
  #BM_Power_FLOAT/9      1537.624473698849 ns    1530.2998740768824 ns       457422
  #BM_Power_FLOAT/10    1537.8752661993187 ns    1530.7318127550295 ns       457326
  #BM_Power_FLOAT/11    1839.3751016921826 ns    1830.8065497602443 ns       382243
  #BM_Power_FLOAT/12    1840.0720637536492 ns    1831.6316314246699 ns       382120
  #BM_Power_FLOAT/13    1839.6525013051378 ns    1831.4300958752372 ns       382059
  #BM_Power_FLOAT/14      2148.22182778337 ns     2138.606070233867 ns       327335
  #BM_Power_FLOAT/15     2452.349344804406 ns     2441.433373571317 ns       286628
  #BM_Power_FLOAT/16     2452.055538106065 ns    2441.4724420438542 ns       286596
  #BM_Power_FLOAT/17    3069.5813045295163 ns     3056.235010106019 ns       229071
  #BM_Power_FLOAT/18    3068.6837668400217 ns     3055.440662658508 ns       229198
  #BM_Power_FLOAT/19     3672.409374171318 ns    3656.6498973574044 ns       191441
  #BM_Power_FLOAT/20     4929.296286126466 ns     4905.616779854631 ns       142683
  #BM_Power_FLOAT/21    4001.2961863843757 ns    3975.4695817490483 ns       176210
  #BM_Power_FLOAT/22      7390.10927792279 ns     7357.815966854894 ns        95097

 */

static constexpr audio_channel_mask_t kChannelPositionMasks[] = {
    AUDIO_CHANNEL_OUT_FRONT_LEFT,
    AUDIO_CHANNEL_OUT_FRONT_CENTER,
    AUDIO_CHANNEL_OUT_STEREO,
    AUDIO_CHANNEL_OUT_2POINT1,
    AUDIO_CHANNEL_OUT_2POINT0POINT2,
    AUDIO_CHANNEL_OUT_QUAD, // AUDIO_CHANNEL_OUT_QUAD_BACK
    AUDIO_CHANNEL_OUT_QUAD_SIDE,
    AUDIO_CHANNEL_OUT_SURROUND,
    AUDIO_CHANNEL_OUT_2POINT1POINT2,
    AUDIO_CHANNEL_OUT_3POINT0POINT2,
    AUDIO_CHANNEL_OUT_PENTA,
    AUDIO_CHANNEL_OUT_3POINT1POINT2,
    AUDIO_CHANNEL_OUT_5POINT1, // AUDIO_CHANNEL_OUT_5POINT1_BACK
    AUDIO_CHANNEL_OUT_5POINT1_SIDE,
    AUDIO_CHANNEL_OUT_6POINT1,
    AUDIO_CHANNEL_OUT_5POINT1POINT2,
    AUDIO_CHANNEL_OUT_7POINT1,
    AUDIO_CHANNEL_OUT_5POINT1POINT4,
    AUDIO_CHANNEL_OUT_7POINT1POINT2,
    AUDIO_CHANNEL_OUT_7POINT1POINT4,
    AUDIO_CHANNEL_OUT_9POINT1POINT6,
    AUDIO_CHANNEL_OUT_13POINT_360RA,
    AUDIO_CHANNEL_OUT_22POINT2,
};

template<audio_format_t FORMAT>
static void BenchmarkPower(benchmark::State& state) {
    const audio_channel_mask_t channelMask = kChannelPositionMasks[state.range(0)];
    const size_t channels = audio_channel_count_from_out_mask(channelMask);

    // set up random generator.
    constexpr float amplitude = 0.01f;
    std::minstd_rand gen(channelMask);
    std::uniform_real_distribution<> dis(-amplitude, amplitude);

    // get random audio data.
    constexpr size_t frameCount = 1024;
    std::vector<float> input(channels * frameCount);
    for (auto& in : input) {
        in = dis(gen);
    }

    // convert to proper PCM format.
    std::vector<uint8_t> buffer(channels * frameCount *  audio_bytes_per_sample(FORMAT));
    memcpy_by_audio_format(buffer.data(), FORMAT, input.data(),
                           AUDIO_FORMAT_PCM_FLOAT, input.size());

    // run the test
    for (auto _ : state) {
        benchmark::DoNotOptimize(buffer);
        audio_utils_compute_energy_mono(buffer.data(), FORMAT, input.size());
        benchmark::ClobberMemory();
    }

    state.SetComplexityN(channels);
    state.SetLabel(audio_channel_out_mask_to_string(channelMask));
}

static void ChannelArgs(benchmark::internal::Benchmark* b) {
    for (int i = 0; i < (int)std::size(kChannelPositionMasks); i++) {
        b->Args({i});
    }
}

static void BM_Power_PCM16(benchmark::State& state) {
    BenchmarkPower<AUDIO_FORMAT_PCM_16_BIT>(state);
}

static void BM_Power_PCM24(benchmark::State& state) {
    BenchmarkPower<AUDIO_FORMAT_PCM_24_BIT_PACKED>(state);
}

static void BM_Power_PCM32(benchmark::State& state) {
    BenchmarkPower<AUDIO_FORMAT_PCM_32_BIT>(state);
}

static void BM_Power_FLOAT(benchmark::State& state) {
    BenchmarkPower<AUDIO_FORMAT_PCM_FLOAT>(state);
}

BENCHMARK(BM_Power_PCM16)->Apply(ChannelArgs);
BENCHMARK(BM_Power_PCM24)->Apply(ChannelArgs);
BENCHMARK(BM_Power_PCM32)->Apply(ChannelArgs);
BENCHMARK(BM_Power_FLOAT)->Apply(ChannelArgs);

BENCHMARK_MAIN();
